<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <title>Editar Producto Electrónico</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script type="text/javascript">
        function validarFormulario() {
            var nombre = document.getElementById('nombre').value.trim();
            var marca = document.getElementById('marca').value;
            var modelo = document.getElementById('modelo').value.trim();
            var precio = parseFloat(document.getElementById('precio').value);
            var detalles = document.getElementById('detalles').value.trim();
            var unidades = parseInt(document.getElementById('unidades').value);
            var imagen = document.getElementById('imagen').value.trim();
              
            var esValido = true;
            
            // Limpiar errores previos
            var errores = document.getElementsByClassName('error');
            while(errores.length > 0) {
                errores[0].parentNode.removeChild(errores[0]);
            }
            
            // a. Validar nombre: Elemento necesario y máximo de 100 caracteres
            if (nombre === '') {
                mostrarError('nombre', 'El nombre es obligatorio, llene el campo');
                esValido = false;
            } else if (nombre.length > 100) {
                mostrarError('nombre', 'El nombre no debe tener más de 100 caracteres');
                esValido = false;
            }
            
            // b. Validar marca: Elemento necesario y que se pueda seleccionar de una lista
            if (marca === '') {
                mostrarError('marca', 'Debes seleccionar una marca de la lista');
                esValido = false;
            }
            
            // c. Validar modelo: Elemento necesario, alfanumérico y máximo de 25 caracteres
            if (modelo === '') {
                mostrarError('modelo', 'El modelo es obligatorio para el registro');
                esValido = false;
            } else if (!/^[a-zA-Z0-9\s]+$/.test(modelo)) {
                mostrarError('modelo', 'El modelo debe ser alfanumérico');
                esValido = false;
            } else if (modelo.length > 25) {
                mostrarError('modelo', 'El modelo no debe tener más de 25 caracteres');
                esValido = false;
            }
            
            // d. Validar precio: Elemento necesario y mayor a 99.99
            if (isNaN(precio)) {
                mostrarError('precio', 'El precio es obligatorio');
                esValido = false;
            } else if (precio <= 99.99) {
                mostrarError('precio', 'El precio debe ser mayor a 99.99');
                esValido = false;
            }
            
            // e. Validar detalles: Elemento necesario y máximo de 250 caracteres
            if (detalles.length > 250) {
                mostrarError('detalles', 'Los detalles no deben tener más de 250 caracteres');
                esValido = false;
            }
            
            // f. Validar unidades: Elemento necesario y mayor o igual a 0
            if (isNaN(unidades)) {
                mostrarError('unidades', 'Las unidades son obligatorias para el registro');
                esValido = false;
            } else if (unidades < 0) {
                mostrarError('unidades', 'Las unidades no pueden ser negativas');
                esValido = false;
            }
            
            // g. Validar imagen: Elemento opcional, pero si está vacío usar imagen por defecto
            if (imagen === '') {
                document.getElementById('imagen').value = 'img/default.png';
            }
            
            if (!esValido) {
                alert('Por favor, cambie los datos para corregir los errores en el formulario');
            }
            
            return esValido;
        }
        
        function mostrarError(campoId, mensaje) {
            var campo = document.getElementById(campoId);
            var error = document.createElement('span');
            error.className = 'error';
            error.textContent = mensaje;
            campo.parentNode.appendChild(error);
        }

        // Función para cargar los datos del producto desde el servidor
        function cargarDatosProducto() {
            // Obtener el ID del producto de la URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (productId) {
                document.getElementById('productId').value = productId;
                
                // Hacer petición al servidor para obtener los datos del producto
                fetch(`get_producto_data.php?id=${productId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al cargar los datos del producto');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Llenar el formulario con los datos del producto
                            document.getElementById('nombre').value = data.producto.nombre || '';
                            document.getElementById('marca').value = data.producto.marca || '';
                            document.getElementById('modelo').value = data.producto.modelo || '';
                            document.getElementById('precio').value = data.producto.precio || '';
                            document.getElementById('detalles').value = data.producto.detalles || '';
                            document.getElementById('unidades').value = data.producto.unidades || '';
                            document.getElementById('imagen').value = data.producto.imagen || 'img/default.png';
                            
                            // Actualizar contador de caracteres
                            document.getElementById('contadorCaracteres').textContent = 
                                document.getElementById('detalles').value.length;
                            
                            // Mostrar información del producto cargado
                            document.getElementById('productInfo').innerHTML = 
                                `<strong>Editando producto:</strong> ID ${data.producto.id} - ${data.producto.nombre}`;
                            document.getElementById('productInfo').style.display = 'block';
                        } else {
                            throw new Error(data.message || 'Error al cargar el producto');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error al cargar los datos del producto: ' + error.message);
                        document.getElementById('productInfo').innerHTML = 
                            `<strong>Error:</strong> ${error.message}`;
                        document.getElementById('productInfo').className = 'alert alert-danger';
                        document.getElementById('productInfo').style.display = 'block';
                    });
            } else {
                document.getElementById('productInfo').innerHTML = 
                    '<strong>Error:</strong> No se proporcionó ID de producto';
                document.getElementById('productInfo').className = 'alert alert-danger';
                document.getElementById('productInfo').style.display = 'block';
            }
        }

        // Cargar datos cuando la página esté lista
        window.onload = cargarDatosProducto;
    </script>
    <style type="text/css">
        .error {
            color: red;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .form-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .header-edicion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .btn-container {
            text-align: center;
            margin-top: 20px;
        }
        .product-info {
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <div class="header-edicion">
                <h2 class="text-center">Editar Producto Electrónico</h2>
                <p class="text-center mb-0">Modifique los datos del producto según sea necesario</p>
            </div>

            <div id="productInfo" class="product-info">
                <!-- Aquí se mostrará la información del producto cargado -->
            </div>

            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Cargando...</span>
                </div>
                <p>Cargando datos del producto...</p>
            </div>

            <form id="formularioProducto" action="update_producto.php" method="post" onsubmit="return validarFormulario()" style="display: none;">
                <!-- Campo oculto para el ID del producto -->
                <input type="hidden" name="id" id="productId" value="">

                <div class="form-group">
                    <label for="nombre" class="font-weight-bold">Nombre:</label> 
                    <input type="text" name="nombre" id="nombre" class="form-control" maxlength="100" required>
                    <small class="form-text text-muted">Máximo 100 caracteres</small>
                </div>

                <div class="form-group">
                    <label for="marca" class="font-weight-bold">Marca:</label> 
                    <select name="marca" id="marca" class="form-control" required>
                        <option value="">Seleccione la marca de su preferencia</option>
                        <option value="Samsung">Samsung</option>
                        <option value="Apple">Apple</option>
                        <option value="Sony">Sony</option>
                        <option value="LG">LG</option>
                        <option value="HP">HP</option>
                        <option value="Dell">Dell</option>
                        <option value="Asus">Asus</option>
                        <option value="Lenovo">Lenovo</option>
                        <option value="Otra">Otra</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="modelo" class="font-weight-bold">Modelo:</label> 
                    <input type="text" name="modelo" id="modelo" class="form-control" maxlength="25" required>
                    <small class="form-text text-muted">Solo caracteres alfanuméricos, máximo 25 caracteres</small>
                </div>

                <div class="form-group">
                    <label for="precio" class="font-weight-bold">Precio:</label> 
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">$</span>
                        </div>
                        <input type="number" name="precio" id="precio" class="form-control" step="0.01" min="100" required>
                    </div>
                    <small class="form-text text-muted">Debe ser mayor a $99.99</small>
                </div>

                <div class="form-group">
                    <label for="detalles" class="font-weight-bold">Detalles:</label>
                    <textarea name="detalles" id="detalles" class="form-control" rows="4" maxlength="250" placeholder="Descripción del producto (máximo 250 caracteres)"></textarea>
                    <small class="form-text text-muted"><span id="contadorCaracteres">0</span>/250 caracteres</small>
                </div>

                <div class="form-group">
                    <label for="unidades" class="font-weight-bold">Unidades:</label> 
                    <input type="number" name="unidades" id="unidades" class="form-control" min="0" required>
                    <small class="form-text text-muted">No puede ser negativo</small>
                </div>

                <div class="form-group">
                    <label for="imagen" class="font-weight-bold">Imagen:</label> 
                    <input type="text" name="imagen" id="imagen" class="form-control" placeholder="img/default.png">
                    <small class="form-text text-muted">URL de la imagen. Si está vacío, se usará la imagen por defecto</small>
                </div>

                <div class="btn-container">
                    <input type="submit" value="Actualizar Producto" class="btn btn-primary btn-lg">
                    <input type="reset" value="Restablecer" class="btn btn-secondary btn-lg">
                    <a href="javascript:history.back()" class="btn btn-outline-secondary btn-lg">Cancelar</a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Contador de caracteres para detalles
        document.getElementById('detalles').addEventListener('input', function() {
            const contador = document.getElementById('contadorCaracteres');
            contador.textContent = this.value.length;
            
            if (this.value.length > 250) {
                contador.style.color = 'red';
            } else {
                contador.style.color = '#6c757d';
            }
        });

        // Ocultar loading y mostrar formulario cuando se carguen los datos
        function mostrarFormulario() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('formularioProducto').style.display = 'block';
        }

        // Modificar la función cargarDatosProducto para mostrar el formulario al final
        const originalCargarDatos = cargarDatosProducto;
        cargarDatosProducto = function() {
            originalCargarDatos();
            // Mostrar formulario después de un tiempo como fallback
            setTimeout(mostrarFormulario, 2000);
        };

        // Mostrar formulario cuando se complete la carga de datos
        window.addEventListener('DOMContentLoaded', function() {
            // Esto se ejecutará cuando el DOM esté listo
        });
    </script>
</body>
</html>